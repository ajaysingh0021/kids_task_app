<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kids Daily Task Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Balsamiq+Sans:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f9ff;
        }
        .balsamiq-sans {
            font-family: 'Balsamiq Sans', cursive;
        }
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        .task-bubble {
            transition: all 0.3s ease-in-out;
            cursor: pointer;
            position: relative;
        }
        .soft-blink {
            animation: soft-blink-animation 2s infinite;
        }
        @keyframes soft-blink-animation {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }
        .task-completed-animation {
            animation: sparkle-animation 0.7s ease-out;
        }
        @keyframes sparkle-animation {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.5; }
            100% { transform: scale(1); opacity: 1; }
        }
        /* Custom scrollbar for a more kid-friendly look */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f0f9ff;
        }
        ::-webkit-scrollbar-thumb {
            background: #60a5fa;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #3b82f6;
        }
        /* Hide number input spinners */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type=number] {
            -moz-appearance: textfield;
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800">

    <!-- Authentication Page -->
    <div id="auth-page" class="max-w-md mx-auto p-4 pt-10">
        <div class="bg-white rounded-xl shadow-lg p-8">
            <h1 class="text-3xl md:text-4xl balsamiq-sans text-blue-600 text-center mb-6">Welcome!</h1>
            
            <!-- Auth Forms Container -->
            <div id="auth-forms">
                <!-- Login Form -->
                <div id="login-form">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Log In to Your Family Account</h2>
                    <div class="space-y-4">
                        <input type="text" id="login-family-name" placeholder="Family Name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400">
                        <input type="password" id="login-pin" placeholder="6-Digit PIN" maxlength="6" pattern="\d{6}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-400" oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                        <button id="login-btn" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Log In</button>
                    </div>
                    <p class="text-center mt-4 text-sm">
                        Don't have an account? <a href="#" id="show-register-link" class="text-purple-600 hover:underline font-semibold">Create one!</a>
                    </p>
                </div>

                <!-- Register Form -->
                <div id="register-form" class="hidden">
                    <h2 class="text-xl font-bold text-gray-700 mb-4 text-center">Create a New Family Account</h2>
                    <div class="space-y-4">
                        <input type="text" id="register-family-name" placeholder="Choose a Family Name" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400">
                        <input type="password" id="register-pin" placeholder="Create a 6-Digit PIN" maxlength="6" pattern="\d{6}" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400" oninput="this.value=this.value.replace(/[^0-9]/g,'');">
                        <button id="register-btn" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-3 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Create Account</button>
                    </div>
                     <p class="text-center mt-4 text-sm">
                        Already have an account? <a href="#" id="show-login-link" class="text-blue-600 hover:underline font-semibold">Log in here.</a>
                    </p>
                </div>
                <p id="auth-error" class="text-red-500 text-center mt-4 font-semibold"></p>
            </div>
        </div>
    </div>

    <!-- Main App Container (hidden until logged in) -->
    <div id="app-container" class="max-w-7xl mx-auto p-4 hidden">

        <!-- Header and Navigation -->
        <header class="bg-white rounded-xl shadow-lg p-4 mb-6 flex justify-between items-center">
            <h1 class="text-3xl md:text-4xl balsamiq-sans text-blue-600">My Daily Tasks!</h1>
            <nav>
                <button id="nav-dashboard" class="nav-btn bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Dashboard</button>
                <button id="nav-settings" class="nav-btn bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105 ml-2">Settings</button>
            </nav>
        </header>

        <!-- Dashboard Page -->
        <main id="dashboard-page" class="page active">
            <div id="dashboard-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
             <div id="no-children-message" class="hidden text-center p-10 bg-white rounded-xl shadow-lg">
                <p class="text-xl text-gray-500">Welcome! ðŸŽ‰</p>
                <p class="mt-2">Please go to the <span class="font-bold text-purple-500">Settings</span> page to add a child and their tasks.</p>
            </div>
        </main>

        <!-- Settings Page -->
        <main id="settings-page" class="page">
            <div class="bg-white rounded-xl shadow-lg p-6">
                <div class="flex justify-between items-start mb-4">
                    <div>
                        <h2 class="text-2xl balsamiq-sans text-purple-600">Settings</h2>
                        <p class="text-gray-600">Family Account: <span id="family-name-display" class="font-bold"></span></p>
                    </div>
                    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Logout</button>
                </div>
                
                <div id="add-child-section" class="mb-6">
                    <h3 class="text-xl font-semibold mb-2 text-gray-700">Add a Child (up to 4)</h3>
                    <div class="flex items-center space-x-2">
                        <input type="text" id="child-name-input" placeholder="Enter child's name" class="flex-grow p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-400">
                        <button id="add-child-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg shadow-md transition-transform transform hover:scale-105">Add Child</button>
                    </div>
                </div>
                <div id="children-config-container" class="space-y-6"></div>
            </div>
        </main>
    </div>
    
    <div id="confirmation-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden z-50">
        <div class="bg-white p-6 rounded-lg shadow-xl text-center">
            <p id="modal-text" class="text-lg mb-4">Are you sure?</p>
            <button id="modal-confirm-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg mr-2">Yes</button>
            <button id="modal-cancel-btn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">No</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, getDoc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        
        // --- Firebase Configuration ---
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : { apiKey: "YOUR_API_KEY", authDomain: "YOUR_AUTH_DOMAIN", projectId: "YOUR_PROJECT_ID" };
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'kids-task-tracker-default';
        
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        // --- State Management ---
        let appData = { children: [] };
        let state = {
            currentPage: 'dashboard',
            familyName: null,
            isLoggedIn: false
        };
        let unsubscribeFromData = null; // To stop listening to Firestore updates on logout

        // --- DOM Elements ---
        const authPage = document.getElementById('auth-page');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const showRegisterLink = document.getElementById('show-register-link');
        const showLoginLink = document.getElementById('show-login-link');
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const authError = document.getElementById('auth-error');
        const familyNameDisplay = document.getElementById('family-name-display');
        
        const pages = { dashboard: document.getElementById('dashboard-page'), settings: document.getElementById('settings-page') };
        const navButtons = { dashboard: document.getElementById('nav-dashboard'), settings: document.getElementById('nav-settings') };
        const dashboardGrid = document.getElementById('dashboard-grid');
        const noChildrenMessage = document.getElementById('no-children-message');
        const addChildBtn = document.getElementById('add-child-btn');
        const childNameInput = document.getElementById('child-name-input');
        const childrenConfigContainer = document.getElementById('children-config-container');
        const addChildSection = document.getElementById('add-child-section');
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalText = document.getElementById('modal-text');
        const modalConfirmBtn = document.getElementById('modal-confirm-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');

        // --- Hashing Utility ---
        async function hashPin(pin) {
            const encoder = new TextEncoder();
            const data = encoder.encode(pin);
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // --- Authentication Logic ---
        showRegisterLink.addEventListener('click', (e) => {
            e.preventDefault();
            loginForm.classList.add('hidden');
            registerForm.classList.remove('hidden');
            authError.textContent = '';
        });

        showLoginLink.addEventListener('click', (e) => {
            e.preventDefault();
            registerForm.classList.add('hidden');
            loginForm.classList.remove('hidden');
            authError.textContent = '';
        });

        registerBtn.addEventListener('click', async () => {
            const familyName = document.getElementById('register-family-name').value.trim().toLowerCase();
            const pin = document.getElementById('register-pin').value;
            authError.textContent = '';

            if (!familyName || !/^\d{6}$/.test(pin)) {
                authError.textContent = 'Please enter a family name and a 6-digit PIN.';
                return;
            }

            const familyDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'families', familyName);
            const familyDoc = await getDoc(familyDocRef);

            if (familyDoc.exists()) {
                authError.textContent = 'This family name is already taken. Please choose another.';
            } else {
                const hashedPin = await hashPin(pin);
                await setDoc(familyDocRef, { pin: hashedPin });
                await login(familyName);
            }
        });

        loginBtn.addEventListener('click', async () => {
            const familyName = document.getElementById('login-family-name').value.trim().toLowerCase();
            const pin = document.getElementById('login-pin').value;
            authError.textContent = '';

            if (!familyName || !pin) {
                authError.textContent = 'Please enter your family name and PIN.';
                return;
            }

            const familyDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'families', familyName);
            const familyDoc = await getDoc(familyDocRef);

            if (!familyDoc.exists()) {
                authError.textContent = 'Family name not found.';
                return;
            }

            const storedPin = familyDoc.data().pin;
            const hashedPin = await hashPin(pin);

            if (storedPin === hashedPin) {
                await login(familyName);
            } else {
                authError.textContent = 'Incorrect PIN.';
            }
        });

        logoutBtn.addEventListener('click', () => {
            localStorage.removeItem('familyName');
            state.isLoggedIn = false;
            state.familyName = null;
            appData = { children: [] };
            
            if (unsubscribeFromData) {
                unsubscribeFromData();
                unsubscribeFromData = null;
            }

            appContainer.classList.add('hidden');
            authPage.classList.remove('hidden');
        });

        async function login(familyName) {
            state.familyName = familyName;
            state.isLoggedIn = true;
            localStorage.setItem('familyName', familyName);
            
            authPage.classList.add('hidden');
            appContainer.classList.remove('hidden');
            familyNameDisplay.textContent = familyName;
            
            setupDataListener();
        }
        
        function setupDataListener() {
            if (unsubscribeFromData) unsubscribeFromData();
            
            const dataDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'familyTasks', state.familyName);
            unsubscribeFromData = onSnapshot(dataDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    appData = docSnap.data();
                    if (!appData.children) appData.children = [];
                } else {
                    appData = { children: [] };
                    setDoc(dataDocRef, appData);
                }
                renderAll();
            }, (error) => {
                console.error("Error listening to document:", error);
            });
        }

        // --- Data Persistence ---
        async function saveData() {
            if (!state.isLoggedIn || !state.familyName) return;
            const dataDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'familyTasks', state.familyName);
            try {
                await setDoc(dataDocRef, appData);
            } catch (error) {
                console.error("Error saving data: ", error);
            }
        }
        
        // --- Core Application Logic (with instant UI updates) ---
        addChildBtn.addEventListener('click', () => {
            const name = childNameInput.value.trim();
            if (name && appData.children.length < 4) {
                appData.children.push({ id: `child_${Date.now()}`, name: name, tasks: [] });
                childNameInput.value = '';
                renderSettings();
                saveData();
            } else if (appData.children.length >= 4) {
                showConfirmationModal("You can add a maximum of 4 children.", null);
            }
        });

        function handleAddTask(childId) {
            const child = appData.children.find(c => c.id === childId);
            if (!child) return;

            const taskDesc = document.getElementById(`task-desc-${childId}`).value.trim();
            const taskType = document.querySelector(`input[name="task-type-${childId}"]:checked`).value;
            const startTime = document.getElementById(`start-time-${childId}`).value;
            const endTime = document.getElementById(`end-time-${childId}`).value;

            if (!taskDesc || !startTime || !endTime) { alert("Please fill in task description, start time, and end time."); return; }
            if (startTime >= endTime) { alert("Start time must be before end time."); return; }

            const weeklyDays = [];
            if (taskType === 'weekly') {
                document.querySelectorAll(`input[name="weekly-day-${childId}"]:checked`).forEach(cb => weeklyDays.push(parseInt(cb.value)));
                if (weeklyDays.length === 0) { alert("Please select at least one day for a weekly task."); return; }
            }

            const newTask = {
                id: `task_${Date.now()}`, description: taskDesc, type: taskType,
                days: weeklyDays, startTime: startTime, endTime: endTime, completions: {}
            };

            child.tasks.push(newTask);
            renderSettings();
            saveData();
        }
        
        function handleDeleteChild(childId) {
            showConfirmationModal("Are you sure you want to remove this child and all their tasks?", () => {
                appData.children = appData.children.filter(c => c.id !== childId);
                renderSettings();
                saveData();
            });
        }

        function handleDeleteTask(childId, taskId) {
            showConfirmationModal("Are you sure you want to delete this task?", () => {
                const child = appData.children.find(c => c.id === childId);
                if (child) {
                    child.tasks = child.tasks.filter(t => t.id !== taskId);
                    renderSettings();
                    saveData();
                }
            });
        }
        
        function toggleTaskCompletion(childId, taskId) {
            const child = appData.children.find(c => c.id === childId);
            const task = child?.tasks.find(t => t.id === taskId);
            if (!task) return;

            const todayStr = new Date().toISOString().slice(0, 10);
            if (task.completions[todayStr]) {
                delete task.completions[todayStr];
            } else {
                task.completions[todayStr] = true;
                const taskElement = document.querySelector(`[data-task-id="${taskId}"]`);
                if (taskElement) {
                    taskElement.classList.add('task-completed-animation');
                    setTimeout(() => taskElement.classList.remove('task-completed-animation'), 700);
                }
            }
            renderDashboard();
            saveData();
        }

        // --- Navigation ---
        function navigate(page) {
            state.currentPage = page;
            Object.values(pages).forEach(p => p.classList.remove('active'));
            Object.values(navButtons).forEach(b => b.classList.remove('ring-2', 'ring-offset-2', 'ring-yellow-400'));
            pages[page].classList.add('active');
            navButtons[page].classList.add('ring-2', 'ring-offset-2', 'ring-yellow-400');
            renderAll();
        }
        navButtons.dashboard.addEventListener('click', () => navigate('dashboard'));
        navButtons.settings.addEventListener('click', () => navigate('settings'));

        // --- Rendering ---
        function renderAll() {
            if (!state.isLoggedIn) return;
            if (state.currentPage === 'dashboard') renderDashboard();
            else if (state.currentPage === 'settings') renderSettings();
        }
        
        function renderDashboard() {
            dashboardGrid.innerHTML = '';
            if (!appData.children || appData.children.length === 0) {
                noChildrenMessage.classList.remove('hidden');
                dashboardGrid.classList.add('hidden');
                return;
            }
            
            noChildrenMessage.classList.add('hidden');
            dashboardGrid.classList.remove('hidden');
            
            const now = new Date();
            const today = (now.getDay() + 6) % 7;
            const currentTime = now.toTimeString().slice(0, 5);
            const todayStr = now.toISOString().slice(0, 10);

            appData.children.forEach(child => {
                const childCol = document.createElement('div');
                childCol.className = 'bg-white rounded-xl shadow-lg p-4 flex flex-col space-y-4';
                
                const todoTasks = child.tasks.filter(task => {
                    const isForToday = task.type === 'general' || task.days.includes(today);
                    return isForToday && !task.completions[todayStr];
                });

                const completedTasks = child.tasks.filter(task => {
                    const isForToday = task.type === 'general' || task.days.includes(today);
                    return isForToday && task.completions[todayStr];
                });

                childCol.innerHTML = `
                    <h3 class="text-2xl balsamiq-sans text-center text-blue-700">${child.name}</h3>
                    <div>
                        <h4 class="font-bold text-lg text-gray-600 mb-2 border-b-2 border-blue-200 pb-1">To Do âœ…</h4>
                        <div id="todo-list-${child.id}" class="space-y-2 min-h-[100px] bg-blue-50 p-2 rounded-lg"></div>
                    </div>
                    <div>
                        <h4 class="font-bold text-lg text-gray-600 mb-2 border-b-2 border-green-200 pb-1">Completed ðŸŽ‰</h4>
                        <div id="completed-list-${child.id}" class="space-y-2 min-h-[100px] bg-green-50 p-2 rounded-lg"></div>
                    </div>
                `;
                dashboardGrid.appendChild(childCol);

                const todoListEl = document.getElementById(`todo-list-${child.id}`);
                const completedListEl = document.getElementById(`completed-list-${child.id}`);
                
                if (todoTasks.length === 0) todoListEl.innerHTML = '<p class="text-gray-400 text-center p-4">All done! Great job! âœ¨</p>';
                else todoTasks.forEach(task => todoListEl.appendChild(createTaskBubble(task, child.id, currentTime)));

                if (completedTasks.length === 0) completedListEl.innerHTML = '<p class="text-gray-400 text-center p-4">Let\'s get some tasks done!</p>';
                else completedTasks.forEach(task => completedListEl.appendChild(createTaskBubble(task, child.id, currentTime)));
            });
        }
        
        function createTaskBubble(task, childId, currentTime) {
            const taskEl = document.createElement('div');
            taskEl.dataset.taskId = task.id;
            taskEl.dataset.childId = childId;
            const isCompleted = task.completions[new Date().toISOString().slice(0, 10)];
            
            let bgColor = 'bg-blue-200', textColor = 'text-blue-800', blinkClass = '';
            if (isCompleted) {
                bgColor = 'bg-green-400'; textColor = 'text-white';
            } else if (currentTime >= task.startTime && currentTime <= task.endTime) {
                bgColor = 'bg-yellow-300'; textColor = 'text-yellow-800'; blinkClass = 'soft-blink';
            } else if (currentTime > task.endTime) {
                bgColor = 'bg-red-400'; textColor = 'text-white';
            }
            
            taskEl.className = `task-bubble p-3 rounded-xl shadow ${bgColor} ${textColor} ${blinkClass} font-semibold flex justify-between items-center`;
            taskEl.innerHTML = `<span>${task.description}</span><span class="text-xs font-normal">${task.startTime} - ${task.endTime}</span>`;
            taskEl.addEventListener('click', () => toggleTaskCompletion(childId, task.id));
            return taskEl;
        }

        function renderSettings() {
            childrenConfigContainer.innerHTML = '';
            addChildSection.style.display = appData.children.length >= 4 ? 'none' : 'block';

            appData.children.forEach(child => {
                const configEl = document.createElement('div');
                configEl.className = 'border border-purple-200 p-4 rounded-lg';
                configEl.innerHTML = `
                    <div class="flex justify-between items-center mb-4">
                        <h4 class="text-xl balsamiq-sans text-purple-700">${child.name}</h4>
                        <button data-delete-child-id="${child.id}" class="delete-child-btn bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-3 rounded-lg text-sm">Remove</button>
                    </div>
                    <div class="bg-gray-50 p-3 rounded-lg mb-4">
                        <h5 class="font-semibold mb-2 text-gray-600">Add New Task</h5>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                            <input type="text" id="task-desc-${child.id}" placeholder="Task description" class="p-2 border rounded-lg">
                            <div class="grid grid-cols-2 gap-2">
                                <input type="time" id="start-time-${child.id}" class="p-2 border rounded-lg" title="Start Time">
                                <input type="time" id="end-time-${child.id}" class="p-2 border rounded-lg" title="End Time">
                            </div>
                        </div>
                        <div class="mt-3">
                            <div class="flex items-center space-x-4 mb-2">
                                <label><input type="radio" name="task-type-${child.id}" value="general" class="mr-1" checked> General</label>
                                <label><input type="radio" name="task-type-${child.id}" value="weekly" class="mr-1"> Weekly</label>
                            </div>
                            <div id="weekly-days-${child.id}" class="hidden flex flex-wrap gap-2 text-sm">
                                ${['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'].map((d, i) => `<label class="flex items-center bg-purple-100 p-2 rounded-md"><input type="checkbox" name="weekly-day-${child.id}" value="${i}" class="mr-1.5"> ${d}</label>`).join('')}
                            </div>
                        </div>
                        <button data-add-task-child-id="${child.id}" class="add-task-btn mt-3 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg w-full">Add Task</button>
                    </div>
                    <div>
                        <h5 class="font-semibold mb-2 text-gray-600">Current Tasks</h5>
                        <ul class="space-y-2">
                            ${child.tasks.length === 0 ? '<li class="text-gray-400">No tasks yet.</li>' : child.tasks.map(task => `
                                <li class="bg-white p-2 rounded-lg border flex justify-between items-center">
                                    <div>
                                        <p class="font-medium">${task.description}</p>
                                        <p class="text-sm text-gray-500">${task.startTime} - ${task.endTime} | ${task.type === 'general' ? 'Daily' : 'Weekly'}</p>
                                    </div>
                                    <button data-delete-task-id="${task.id}" data-child-id="${child.id}" class="delete-task-btn bg-red-100 hover:bg-red-200 text-red-700 font-bold py-1 px-2 rounded-md text-xs">Delete</button>
                                </li>`).join('')}
                        </ul>
                    </div>`;
                childrenConfigContainer.appendChild(configEl);
            });
        }

        // --- Confirmation Modal Logic ---
        let confirmCallback = null;
        function showConfirmationModal(text, callback) {
            modalText.textContent = text;
            confirmCallback = callback;
            confirmationModal.classList.remove('hidden');
        }
        modalConfirmBtn.addEventListener('click', () => {
            if (confirmCallback) confirmCallback();
            confirmationModal.classList.add('hidden');
        });
        modalCancelBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));

        // --- Event Delegation ---
        document.body.addEventListener('click', (e) => {
            if (e.target.matches('.delete-child-btn')) handleDeleteChild(e.target.dataset.deleteChildId);
            if (e.target.matches('.add-task-btn')) handleAddTask(e.target.dataset.addTaskChildId);
            if (e.target.matches('.delete-task-btn')) handleDeleteTask(e.target.dataset.childId, e.target.dataset.deleteTaskId);
        });
        document.body.addEventListener('change', (e) => {
            if (e.target.matches('input[name^="task-type-"]')) {
                const childId = e.target.name.replace('task-type-', '');
                document.getElementById(`weekly-days-${childId}`).style.display = e.target.value === 'weekly' ? 'flex' : 'none';
            }
        });

        // --- Initial Load ---
        async function initializeAppOnLoad() {
            authPage.classList.add('hidden');
            appContainer.classList.add('hidden');

            try {
                // FIX: Use the platform-provided custom token if available, otherwise fall back to anonymous sign-in.
                // This is the correct way to authenticate to get the necessary permissions.
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
                
                const savedFamilyName = localStorage.getItem('familyName');
                if (savedFamilyName) {
                    await login(savedFamilyName);
                } else {
                    authPage.classList.remove('hidden');
                }

                setInterval(() => {
                    if(state.isLoggedIn) renderDashboard();
                }, 60000);

            } catch (error) {
                console.error("Firebase initialization failed:", error);
                authPage.classList.remove('hidden');
                authError.textContent = "Error connecting to the service. Please refresh the page.";
            }
        }
        
        initializeAppOnLoad();

    </script>
</body>
</html>
